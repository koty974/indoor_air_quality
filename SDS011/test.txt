#include "sds011.h"
#include <stdio.h>
#include <fcntl.h>
#include <termios.h>
#include <unistd.h>

int main(void) {
    // Open serial port (adjust device path as needed)
    int fd = open("/dev/ttyUSB0", O_RDWR | O_NOCTTY);
    if (fd < 0) {
        perror("Failed to open serial port");
        return 1;
    }

    // Configure UART (9600 baud, 8N1)
    struct termios options;
    tcgetattr(fd, &options);
    cfsetispeed(&options, B9600);
    cfsetospeed(&options, B9600);
    options.c_cflag &= ~PARENB; // No parity
    options.c_cflag &= ~CSTOPB; // 1 stop bit
    options.c_cflag &= ~CSIZE;
    options.c_cflag |= CS8;     // 8 data bits
    options.c_cflag |= CREAD | CLOCAL; // Enable receiver
    tcsetattr(fd, TCSANOW, &options);

    SDS011 sensor;
    SDS011_Data data;

    sds011_init(&sensor, fd);

    // Ask sensor for new data
    sds011_request_data(&sensor);

    // Wait a moment (sensor needs some time to respond)
    usleep(1000000); // 1 second

    // Try to read data frame
    if (sds011_read(&sensor, &data))
        printf("PM2.5 = %.1f µg/m³, PM10 = %.1f µg/m³\n", data.pm25, data.pm10);
    else
        printf("Failed to read valid data.\n");

    close(fd);
    return 0;
}
